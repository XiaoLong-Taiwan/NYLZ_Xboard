# 节点状态监控插件

## 📋 功能介绍

这是一个用于XBoard的节点状态监控插件，主要功能包括：

- 🔍 **实时监控**：定时检查指定节点的连通性
- 📱 **Telegram通知**：节点离线/恢复时自动发送通知到指定群组或频道
- ⚙️ **灵活配置**：支持多节点监控、自定义检查间隔、重试机制等
- 🔧 **手动管理**：提供API接口进行手动检查和管理
- 📊 **状态缓存**：记录节点历史状态，避免重复通知

## 🚀 安装配置

### 1. 插件配置

在XBoard管理后台的插件管理页面，找到"节点状态监控"插件并进行以下配置：

#### 基础配置
- **Telegram Bot Token**：你的Telegram机器人Token
- **聊天ID**：接收通知的群组或频道ID（支持多个，用逗号分隔）
- **检查间隔**：节点状态检查间隔时间（秒，默认60秒）
- **超时时间**：节点连接超时时间（秒，默认10秒）
- **重试次数**：节点连接失败重试次数（默认3次）

#### 节点配置
- **自动发现节点**：启用后将自动监控系统中的常见服务节点
- **监控节点**：要监控的节点列表，格式：`名称1:地址1:端口1,名称2:地址2:端口2`
  
  示例：`主节点:example.com:443,备用节点:backup.example.com:8080`
  
  **自动发现模式**：当启用自动发现且监控节点配置为空时，将自动监控以下节点：
  - 本地Web服务 (localhost:80)
  - 本地HTTPS服务 (localhost:443) 
  - 本地MySQL (localhost:3306)
  - 本地Redis (localhost:6379)
  - 系统配置的数据库和Redis服务器（如果不是本地）

#### 高级配置
- **启用恢复通知**：节点恢复连接时是否发送通知（默认启用）

### 2. Telegram Bot 设置

#### 创建Bot
1. 在Telegram中搜索 `@BotFather`
2. 发送 `/newbot` 创建新机器人
3. 按提示设置机器人名称和用户名
4. 获取Bot Token并填入插件配置

#### 获取Chat ID

**群组/频道ID：**
1. 将机器人添加到群组或频道
2. 在群组中发送一条消息
3. 访问：`https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`
4. 在返回的JSON中找到 `chat.id` 字段

**私聊ID：**
1. 与机器人私聊发送任意消息
2. 同样访问上述URL获取chat.id

## 🔧 API接口

### 认证接口

所有管理接口都需要认证，请在请求头中包含有效的认证信息。

#### 1. 手动检查节点状态
```http
POST /api/v1/node-monitor/check
```

**响应示例：**
```json
{
  "code": 200,
  "data": {
    "message": "节点状态检查完成",
    "nodes": [
      {
        "name": "主节点",
        "host": "example.com",
        "port": 443,
        "status": "online",
        "checked_at": "2024-01-01 12:00:00"
      }
    ],
    "total": 2,
    "online": 1,
    "offline": 1
  }
}
```

#### 2. 获取节点状态
```http
GET /api/v1/node-monitor/status
```

#### 3. 发送测试通知
```http
POST /api/v1/node-monitor/test-notification
```

#### 4. 清除状态缓存
```http
DELETE /api/v1/node-monitor/cache
```

### 公开接口

#### 获取节点状态概览
```http
GET /api/v1/node-monitor/public/overview
```

## 📱 通知示例

### 离线通知
```
🔴 节点离线警告

节点名称: 主节点
节点地址: example.com:443
状态: 离线
时间: 2024-01-01 12:00:00
```

### 恢复通知
```
🟢 节点恢复通知

节点名称: 主节点
节点地址: example.com:443
状态: 在线
时间: 2024-01-01 12:05:00
```

## ⚡ 工作原理

1. **定时检查**：插件根据配置的间隔时间定时检查所有节点
2. **连通性测试**：使用TCP连接测试节点的可达性
3. **重试机制**：连接失败时会根据配置进行重试
4. **状态比较**：将当前状态与缓存状态比较，只在状态变化时发送通知
5. **通知发送**：通过Telegram Bot API发送通知到指定聊天

## 🔍 故障排除

### 常见问题

1. **收不到通知**
   - 检查Bot Token是否正确
   - 确认Chat ID是否正确
   - 确保机器人已添加到群组/频道
   - 检查网络连接是否正常

2. **节点检查不准确**
   - 调整超时时间设置
   - 增加重试次数
   - 检查节点地址和端口是否正确

3. **定时任务不执行**
   - 确保插件已启用
   - 检查Laravel定时任务是否正常运行
   - 查看系统日志获取详细错误信息

### 日志查看

插件会记录详细的运行日志，可以在Laravel日志文件中查看：
- 节点检查结果
- 通知发送状态
- 错误信息

## 📝 更新日志

### v1.0.0
- 初始版本发布
- 支持多节点监控
- Telegram通知功能
- 完整的API接口
- 状态缓存机制

## 🤝 技术支持

如有问题或建议，请通过以下方式联系：
- 提交Issue到项目仓库
- 联系插件作者：大熊

## 📄 许可证

本插件遵循MIT许可证开源。